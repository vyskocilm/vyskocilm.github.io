<!doctype html>
<html lang="en">

    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta name="description" content="">
        <meta name="author" content="">

        <!--
        <link rel="stylesheet" href="../../static/style.css">
        -->
        <!-- Bootstrap core CSS -->
        <link href="../../vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

        <!-- Custom fonts for this template -->
        <link href="../../vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

        <!-- Custom styles for this template -->
        <link href="../../static/clean-blog.min.css" rel="stylesheet">

        <!-- Pygments - code highlighting styles -->
        <link rel="stylesheet" href="../../static/pygments.css">

        <title>Correct use of SQL transaction in Postgres from Go â€” miblog</title>
    </head>

    <body>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
        <div class="container">
            <a class="navbar-brand" href="index.html">MIBLOG</a>
            <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                Menu
                <i class="fa fa-bars"></i>
            </button>
            <div class="collapse navbar-collapse" id="navbarResponsive">
                <ul class="navbar-nav ml-auto">
                    
                    <li class="nav-item" endif
                        %}><a class="nav-link" href="../../">Home</a></li>
                    
                    <li class="nav-item" endif
                        %}><a class="nav-link" href="../../blog/">Blog</a></li>
                    
                    <li class="nav-item" endif
                        %}><a class="nav-link" href="../../projects/">Projects</a></li>
                    
                    <li class="nav-item" endif
                        %}><a class="nav-link" href="../../about/">About</a></li>
                    

                </ul>
            </div>
        </div>
    </nav>

    <!-- page header -->
    <header class="masthead" style="background-image: url('../../static/Lake_Hayes_by_queenstown.jpg')">
      <div class="overlay"></div>
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-md-10 mx-auto">
            <div class="site-heading">
              <h1>Miblog</h1>
              <!--
              <span class="subheading">Thoughts and ideas</span>
              -->
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- TODO: copy boostrap style -->
    <!-- Main Content -->
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
        
  
  <div class="blog-post">
  
    <h2>Correct use of SQL transaction in Postgres from Go</h2>
  
  <p class="meta">
    written by
    
      <a href="https://twitter.com/@vyskocilm">Michal Vyskocil</a>
    
    on 2019-05-21
  </p>
  
  <h2>Problem</h2>
<p>Once upon a time I got a task to merge duplicate URLs in our production database. It turned out that there were a lot of same urls like <code>https://example.com?fbclid=1234</code> and <code>https://example.com?fbclid=5678</code> we wanted to merge.  Code to normalize URL was easy
to develop. Code to migrate the database looked easy as weel. Until I turned the transaction on. Then very cryptic message appeared</p>
<div class="hll"><pre><span></span> pq: unexpected Parse response <span class="s1">&#39;C&#39;</span>
</pre></div>
<p>The error message was telling me <em>nothing</em>. And what is worse <a href="https://duck.com">ducking</a> did not revealed anything. Except notes about Postgres protocol internals., which was something I did not wanted to dig into.  It was a hint from <a href="https://github.com/karolhrdina">@karolhrdina</a> who have explained me the root cause well enough, so I can share my experience in my blog. Lessons learned - always work with a great colleagues, you can learn a lot from them!</p>
<p>Following text assume reader know about Go, particularly <code>database/sql</code> and <code>lib/pq</code>,  Postgres or SQL databases in general.</p>
<h2>The code</h2>
<p>Following snippet omits a lot of details, but shows the algorithm</p>
<div class="hll"><pre><span></span><span class="nx">rows</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">Query</span><span class="p">(</span><span class="s">&quot;SELECT id, url, visists FROM schema.url WHERE url LIKE $1 ORDER BY id&quot;</span><span class="p">,</span> <span class="nx">pattern</span><span class="p">)</span>

<span class="k">for</span> <span class="nx">rows</span><span class="p">.</span><span class="nx">Next</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">err</span> <span class="p">=</span> <span class="nx">rows</span><span class="p">.</span><span class="nx">Scan</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">url</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">visits</span><span class="p">)</span>
        <span class="nx">urlNormalized</span> <span class="o">:=</span> <span class="nx">URLNormalize</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">url</span> <span class="o">!=</span> <span class="nx">urlNormalized</span> <span class="p">{</span>
                <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">Exec</span><span class="p">(</span><span class="s">&quot;INSERT INTO schema.url AS u (url, visits) VALUES ($1, 1) ON CONFLICT url DO UPDATE SET visists=u.visists+$2;&quot;</span><span class="p">,</span> <span class="nx">urlNormalized</span><span class="p">,</span> <span class="nx">vists</span><span class="p">)</span>
                <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">Exec</span><span class="p">(</span><span class="s">&quot;DELETE FROM schema.url WHERE id=$1&quot;</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span>
        <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<ol>
<li>For all urls matching the bad pattern do</li>
<li>Try to normalize and if there is normalized version then</li>
<li>UPSERT new entry or increase a number of visits</li>
<li>... and program crashes</li>
</ol>
<p>The problem I was facing is connected with how Postgres protocol works. It turns out that you can't call <code>Exec</code> if you did not read all the data from previous <code>Query</code>. The problem is that most of Postgres drivers including its own<code>libpq</code> does <em>fetch all the rows</em> by default. It gives the false impression that following code is legal and works.  Go driver <code>lib/pq</code> does not do it. <code>plpgsql</code> does handle this case well. Other language bindings fetch the data by default.</p>
<p>However fetching the data was not an option as there are millions of entries. And using different language than Go was impractical. Url normalization has been written in Go and there are huge differences between language parsers of URLs between languages.  For example PHP handles query strings in really <a href="https://www.php.net/manual/en/function.parse-str.php#76792">bizzare</a> way incompatible with CGI BIN, Perl and any other language. One can build Go code as (C like) shared library, but that would be somewhat big effort.</p>
<p>Fetching data was an option, however given the number of entries, one would need to play with <code>LIMIT</code> and <code>OFFSET</code> to achieve reasonable size of input data.</p>
<h2>Do it as plpgsql</h2>
<p>There is object called <a href="https://www.postgresql.org/docs/10/plpgsql-cursors.html">cursor</a>. Cursors are intended exactly for this use case. They <strong>encapsulates</strong> the query and one can read a few results at the time. And <code>plpgsql</code> uses cursors under the hood. It turns out <code>CURSOR</code> can be used from Go code as well</p>
<p>So Go code changes a bit. There is no <code>*sql.Rows</code> and no <code>Next()</code> method to be used in the loop.</p>
<div class="hll"><pre><span></span><span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">Exec</span><span class="p">(</span><span class="s">&quot;DECLARE url_cur CURSOR FOR SELECT id, url, visits FROM schema.url WHERE url LIKE $1 ORDER BY id&quot;</span><span class="p">,</span> <span class="nx">pattern</span><span class="p">)</span>
<span class="k">defer</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">Exec</span><span class="p">(</span><span class="s">&quot;CLOSE url_cur&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="p">{</span>
        <span class="nx">err</span> <span class="p">=</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">QueryRow</span><span class="p">(</span><span class="s">&quot;FETCH NEXT FROM url_cur&quot;</span><span class="p">).</span><span class="nx">Scan</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">url</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">visits</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">ErrNoRows</span> <span class="p">{</span>
            <span class="k">break</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">_</span> <span class="p">=</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">Rollback</span><span class="p">()</span>
        <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
        <span class="c1">// call tx.Exec with UPSERT and DELETE</span>
<span class="p">}</span>
</pre></div>
<p>The advantages are</p>
<ol>
<li>No new language in the stack, neither complicated integration of Go code into another language</li>
<li>It is efficient and works with one entry at the time</li>
<li>There are minimal changes to Go code</li>
<li>It works, data are written on <code>tx.Commit()</code></li>
</ol>
<p>Big thanks comes to <a href="https://github.com/hypnoglow">@hypnoglow</a> and his comment at Github <a href="https://github.com/lib/pq/issues/635#issuecomment-327800640">issue#635</a></p>

  
  </div>


        </div>
      </div>
    </div>

    <hr>

    <!-- footer -->
    <footer>
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-md-10 mx-auto">
            <ul class="list-inline text-center">
              <li class="list-inline-item">
                <a href="mailto:michal.vyskocil@gmail.com">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-mail fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li class="list-inline-item">
                <a href="https://twitter.com/vyskocilm">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li class="list-inline-item">
                <a href="https://github.com/vyskocilm">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li class="list-inline-item">
                <a href="https://www.facebook.com/michal.vyskocil.148">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
            </ul>
            <p class="copyright text-muted">Copyright &copy; Michal Vyskocil 2018.<br/>Based on <a href="https://startbootstrap.com/template-overviews/clean-blog/">Bootstrap Clean Blog</a>, powered by <a href="https://getlektor.com">Lektor SCM</a></p>
          </div>
        </div>
      </div>
    </footer>

    <!-- Bootstrap core JavaScript -->
    <script src="../../vendor/jquery/jquery.min.js"></script>
    <script src="../../vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Custom scripts for this template -->
    <script src="../../static/clean-blog.min.js"></script>
    </body>

</html>
