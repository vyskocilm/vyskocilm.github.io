<!doctype html>
<html lang="en">

    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta name="description" content="">
        <meta name="author" content="">

        <!--
        <link rel="stylesheet" href="../../static/style.css">
        -->
        <!-- Bootstrap core CSS -->
        <link href="../../vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

        <!-- Custom fonts for this template -->
        <link href="../../vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

        <!-- Custom styles for this template -->
        <link href="../../static/clean-blog.min.css" rel="stylesheet">

        <!-- Pygments - code highlighting styles -->
        <link rel="stylesheet" href="../../static/pygments.css">

        <title>Speeding your CI with go mod download ... again â€” miblog</title>
    </head>

    <body>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
        <div class="container">
            <a class="navbar-brand" href="index.html">MIBLOG</a>
            <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                Menu
                <i class="fa fa-bars"></i>
            </button>
            <div class="collapse navbar-collapse" id="navbarResponsive">
                <ul class="navbar-nav ml-auto">
                    
                    <li class="nav-item" endif
                        %}><a class="nav-link" href="../../">Home</a></li>
                    
                    <li class="nav-item" endif
                        %}><a class="nav-link" href="../../blog/">Blog</a></li>
                    
                    <li class="nav-item" endif
                        %}><a class="nav-link" href="../../projects/">Projects</a></li>
                    
                    <li class="nav-item" endif
                        %}><a class="nav-link" href="../../about/">About</a></li>
                    

                </ul>
            </div>
        </div>
    </nav>

    <!-- page header -->
    <header class="masthead" style="background-image: url('../../static/Lake_Hayes_by_queenstown.jpg')">
      <div class="overlay"></div>
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-md-10 mx-auto">
            <div class="site-heading">
              <h1>Miblog</h1>
              <!--
              <span class="subheading">Thoughts and ideas</span>
              -->
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- TODO: copy boostrap style -->
    <!-- Main Content -->
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
        
  
  <div class="blog-post">
  
    <h2>Speeding your CI with go mod download ... again</h2>
  
  <p class="meta">
    written by
    
      <a href="https://twitter.com/vyskocilm">Michal Vyskocil</a>
    
    on 2019-02-13
  </p>
  
  <p>Running <code>go mod download</code> slows down each CI run a lot. More dependencies increases time and it wastes the bandwidth again and again. As we do use special CI containers for the task, then go modules can be downloaded during container build phase and CI build will benefit from it. There are many articles about this topic. However most of them discuss one go module per repository or Docker image. As I wrote recently, we do use <a href="https://vyskocilm.github.io/blog/go-111-modules-monorepo-and-shared-code">monorepo with many go modules</a>. So here is the short howto article how to squash all your go.mod files to one to simplify container build. And speedup your CI of course.</p>
<h2>The problem</h2>
<p>The problem was that <code>go.mod</code> files are scattered around git repo and <code>go mod download</code> expects exactly one file to be used. There were two things comes into my mind</p>
<ol>
<li>regenerate directory structure as a part of Docker file and copy <code>go.mod</code> and <code>go.sum</code> files there and call <code>go mod download</code> for each of those</li>
<li>or to squash all the files together to see what will happen</li>
</ol>
<p>Number one does not look like <em>sexy</em> approach and it will complicate the Dockerfile a lot. So the second one looked like better approach.</p>
<h2>Squashing</h2>
<p>Fortunately <code>go.mod</code> have script friendly structure, so could be easy to call a few unix tools to do the work. See an example from <a href="https://github.com/vyskocilm/gazpacho/blob/master/project1-serviceA/go.mod">example repository gazpacho</a></p>
<pre><code>module github.com/vyskocilm/gazpacho/project1-serviceA

require (
    github.com/vyskocilm/gazpacho/g/cfg v0.0.0-20181109075706-a4ae50527451
    gopkg.in/yaml.v2 v2.2.1 // indirect
)

replace github.com/vyskocilm/gazpacho/g/cfg =&gt; ../g/cfg
</code></pre>
<p>What we are interested in is the part between <code>require (</code> and <code>)</code> and it turned out that <code>sed</code> is a perfect tool for.</p>
<div class="hll"><pre><span></span>sed -n -e <span class="s1">&#39;/^require (/,/^)$/p&#39;</span> go.mod <span class="p">|</span> sed <span class="s1">&#39;1d;/^)$d&#39;</span>
        github.com/vyskocilm/gazpacho/g/cfg v0.0.0-20181109075706-a4ae50527451
        gopkg.in/yaml.v2 v2.2.1 // indirect
</pre></div>
<p>First we print everything between <code>require (</code> and <code>)</code>, see <code>p</code>rint command in first <code>sed</code> invocation. Then we strip the first line (<code>1d</code>) and line with <code>)</code>.</p>
<p>Then we can  combine everything to such awesome shell magic.</p>
<div class="hll"><pre><span></span>find <span class="k">$(</span>git rev-parse --show-toplevel<span class="k">)</span> -mindepth <span class="m">2</span> -name <span class="s1">&#39;go.mod&#39;</span> <span class="p">|</span> <span class="k">while</span> <span class="nb">read</span> GOMOD
<span class="k">do</span>
    sed -n -e <span class="s1">&#39;/^require (/,/^)$/p&#39;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">GOMOD</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">|</span> sed <span class="s1">&#39;1d;/^)$/d&#39;</span>
<span class="k">done</span> <span class="p">|</span> sort -u <span class="p">|</span> grep -v <span class="s1">&#39;internal.git.repo&#39;</span> &gt;&gt; go.mod
</pre></div>
<p>Which will</p>
<ol>
<li>find all <code>go.mod</code> files from your monorepo (ignoring the top level one, this is <code>-mindepth 2</code> is about)</li>
<li>for <strong>each</strong> of those it will print the lines with dependencies</li>
<li>then all the lines will be sorted, all duplicates removed</li>
<li>additionally all dependencies points to internal repo were removed.-As <a href="https://vyskocilm.github.io/blog/go-111-modules-monorepo-and-shared-code">monorepo with many go modules</a> article discuss, we do use <code>replace</code> directive. We do not care tah much about downloading internal dependencies. They are in as a part of git checkout anyway. Additionally one would need to pass <code>gitlab</code> credentials into Docker build somehow. Better to not do it.</li>
</ol>
<h2>What about go.sum</h2>
<div class="hll"><pre><span></span>find <span class="k">$(</span>git rev-parse --show-toplevel<span class="k">)</span> -mindepth <span class="m">2</span> -name <span class="s1">&#39;go.sum&#39;</span> <span class="p">|</span> xargs sort -u <span class="p">|</span> grep -v <span class="s1">&#39;internal.git.repo&#39;</span> &gt; go.sum
</pre></div>
<p>There is nothing to show, format is line oriented, so friendly to unix tools without any hacking</p>

  
  </div>


        </div>
      </div>
    </div>

    <hr>

    <!-- footer -->
    <footer>
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-md-10 mx-auto">
            <ul class="list-inline text-center">
              <li class="list-inline-item">
                <a href="mailto:michal.vyskocil@gmail.com">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-mail fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li class="list-inline-item">
                <a href="https://twitter.com/vyskocilm">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li class="list-inline-item">
                <a href="https://github.com/vyskocilm">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li class="list-inline-item">
                <a href="https://www.facebook.com/michal.vyskocil.148">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
            </ul>
            <p class="copyright text-muted">Copyright &copy; Michal Vyskocil 2018.<br/>Based on <a href="https://startbootstrap.com/template-overviews/clean-blog/">Bootstrap Clean Blog</a>, powered by <a href="https://getlektor.com">Lektor SCM</a></p>
          </div>
        </div>
      </div>
    </footer>

    <!-- Bootstrap core JavaScript -->
    <script src="../../vendor/jquery/jquery.min.js"></script>
    <script src="../../vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Custom scripts for this template -->
    <script src="../../static/clean-blog.min.js"></script>
    </body>

</html>
