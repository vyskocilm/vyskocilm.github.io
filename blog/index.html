<!doctype html>
<html lang="en">

    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta name="description" content="">
        <meta name="author" content="">

        <!--
        <link rel="stylesheet" href="../static/style.css">
        -->
        <!-- Bootstrap core CSS -->
        <link href="../vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

        <!-- Custom fonts for this template -->
        <link href="../vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

        <!-- Custom styles for this template -->
        <link href="../static/clean-blog.min.css" rel="stylesheet">

        <title> â€” miblog</title>
    </head>

    <body>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
        <div class="container">
            <a class="navbar-brand" href="index.html">MIBLOG</a>
            <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                Menu
                <i class="fa fa-bars"></i>
            </button>
            <div class="collapse navbar-collapse" id="navbarResponsive">
                <ul class="navbar-nav ml-auto">
                    
                    <li class="nav-item" endif
                        %}><a class="nav-link" href="../">Home</a></li>
                    
                    <li class="nav-item" endif
                        %}><a class="nav-link" href="../blog/">Blog</a></li>
                    
                    <li class="nav-item" endif
                        %}><a class="nav-link" href="../projects/">Projects</a></li>
                    
                    <li class="nav-item" endif
                        %}><a class="nav-link" href="../about/">About</a></li>
                    

                </ul>
            </div>
        </div>
    </nav>

    <!-- page header -->
    <header class="masthead" style="background-image: url('../static/Lake_Hayes_by_queenstown.jpg')">
      <div class="overlay"></div>
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-md-10 mx-auto">
            <div class="site-heading">
              <h1>Miblog</h1>
              <!--
              <span class="subheading">Thoughts and ideas</span>
              -->
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- TODO: copy boostrap style -->
    <!-- Main Content -->
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
        
  
    
  <div class="blog-post">
  
    <h2><a href="../blog/limiting-your-goroutines/">Limiting your goroutines</a></h2>
  
  <p class="meta">
    written by
    
      <a href="https://twitter.com/vyskocilm">Michal Vyskocil</a>
    
    on 2018-10-10
  </p>
  <h1>Limiting your goroutines</h1><p>
How to properly implement goroutine pool in golang with input and output channel(s). Text expects knowledge about <a href="https://golang.org/">golang</a> and about <a href="https://tour.golang.org/concurrency/1">Go Concurency</a>. That means I am not going to explain what goroutine, channel or defer actually are.
</p><h2>Intro</h2>
<p>
Gorutines are some kind of lightweight threads managed by userspace golang runtime. They save memory and context switches. Therefor it is possible to spawn literally <a href="https://rcoh.me/posts/why-you-can-have-a-million-go-routines-but-only-1000-java-threads/">Millions!</a> of them.  However as BenPar^W Voltaire said
<p/>

<p>
<img src="https://media.licdn.com/media/gcrc/dms/image/C4E12AQFoCyvG3y_XEA/article-cover_image-shrink_600_2000/0?e=1544659200&v=beta&t=nNlZk3EjA5HecFvdl52P0qsWxmeuBbLq81ESKDa04ms" alt="With great power comes great responsibility" />
<a href="https://www.linkedin.com/pulse/quote-great-power-comes-responsibility-voltaire-mba-bsee/">Source: linkedin</a>
</p>

<p>
It is not always practical to spawn your task million times. For example when you need to crawl web pages. It's good idea to NOT do it millions of times at the same time. On the other hand this is EXACTLY the kind of task golang and its goroutines shines at. The way of solving it is called <strong>pool</strong>, or workers, task queue, whatever you want. The idea is the same, we have a huge number N of tasks, which will be distributed to smaller number P of goroutines. Each goroutine will read next input from the channel, do the work and return result on a channel. This way we can parameterize the number of concurrent tasks we run. We can measure speed of execution using different numbers.  Or we can ensure our code can deal with huge input without crashing the world :-)
</p>

<h2>Deadlocks everywhere</h2><p>The situation looks simple. Golang is an advanced language with builtin support for goroutines and concurrency. One just need to search the internet a bit to find an example. Knowing very little about golang, I naturally came to <a href="https://stackoverflow.com/questions/29342701/write-to-same-channel-with-multiple-goroutines">StackOverflow</a> to get the examples of READing data from the go channel. And the <a href="https://play.golang.org/p/ESq9he_WzS">code</a> looked simple and printed all numbers. That means we can <strong>distribute</strong> data from one channel and <strong>consume</strong> them from go routines. And golang runtime will make the magic behind to make this happen.</p><p>
So let's add writing to the an another output channel. We will read it from main thread and everything should work! Something like <a href="https://gobyexample.com/worker-pools">Worker pools @gobyexample.com</a>.
</p><p>
And BAM! Code deadlock!
</p><p>
<img src="http://nikolar.com/wp-content/uploads/2013/09/trafficDeadlock.jpg" alt="deadlock"/>
<a href="http://nikolar.com/tag/deadlock/">Source: nikolar.com</a>

<p>
Program crashed and never print anything. Panic mode started. To make the long story short. Here is the key
</p><blockquote>
You MUST read from channel you're writing into, or BAD things will happen.
</blockquote><p>
My code was structured this way
<ol>
<li>After some init, create P goroutines and execute them</li>
<li>Write data to input channel</li>
<li>Read results from output channel</li>
</ol>

But program stopped in part 2, so reading of the data never happened, which blocked the send part inside goroutines, ... there is no better word than <strong>deadlock</strong> to describe the situation.
</p><p><h2>The solution</h2></p>
<p>
 Fortunately golang provides a simple way to fix it. <em>Offload the second part to goroutine</em>. We can read from output channel immediately from main thread. Full code available on <a href="https://play.golang.org/p/hTHhgZy-KvV">https://play.golang.org</a> or below
</p><script src="https://gist.github.com/vyskocilm/d0c1a2f57a9b0821c00f31190c167781.js"></script>
  </div>

  
    
  <div class="blog-post">
  
    <h2><a href="../blog/modern-javascript-development-for-oldies/">&#34;Modern&#34; Javascript development for oldies</a></h2>
  
  <p class="meta">
    written by
    
      <a href="https://twitter.com/@vyskocilm">Michal Vyskocil</a>
    
    on 2018-04-04
  </p>
  <h2>My Javascript experience</h2><p>When I started my career, I was working as Junior Developer on web based application. We have had parts written in <a href="https://en.wikipedia.org/wiki/JavaServer_Pages">Java Server Pages</a>, which was great technology combining elegance of PHP with easy to use of Java. We had something in <a href="https://en.wikipedia.org/wiki/Java_servlet">Java servlets</a>, which allows us easier testing and compilation up front. Other parts were in <a href="
https://en.wikipedia.org/wiki/PL/SQL">PL/SQL</a>. And of course, the Javascript.</p>
<p>And most of our clients has been using <a href="https://davidwalsh.name/6-reasons-why-ie6-must-die">Internet Explorer 6</a> at the time! XmlHttpRequest was a neat new thing, jQuery was a hot new technology. The common way to have JS integrated was through session objects, so the logic of application was scattered through several pages (JSPs or Servlets) and it relied on server side rendering heavily.</p>
<p>At that time I decided to <strong>never</strong> touch Javascript at all.</p>
<h2>Fast forward to 2018</h2><p>The world has changed. Browsers are more and more ubiquitous, we got more platforms (TVs, consoles and phones). So if you want to spread your small application to your friends, then web application is the easiest way to do. Fortunately Javascript become more powerful and compatible across browsers. The main shift of paradigm is client side rendering. There is no need to do horrible things like passing session objects and initialize all you JS again and again. You can manage all your state in one place.</p>
<p>And that's not all. With advent of technologies like <a href="http://webassembly.org/">Webassembly</a> and <a href="https://github.com/kripken/emscripten">Emscripten</a> you can have crazy things like <a href="https://github.com/kripken/sql.js">native sqlite</a> database running in your browser. Plus you can offload heavy CPU intensive tasks (like SQL queries) to <a href="https://en.wikipedia.org/wiki/Web_worker">Web worker</a>.</p>
<h2>"Modern" JS development for dummies</h2><p>Of course things are not <em>that</em> easy for dummies. You have <a href="https://nodejs.org/en/">nodejs</a>, <a href="https://www.npmjs.com/">npm</a> package manager (or shall I use <a href="https://yarnpkg.com/en/">yarn</a>?). Should I learn AngularJS, ReactJs, Redux, Webpack, Gulp, Vue.js, Grunt? You can easily fall into the trap of choosing the right tools, frameworks and workflows, spending hours on watching youtube videos and reading documentation, while not implementing a single line.</p>
<p>The thing is - it <strong>does not matter</strong>. Keep it simple, implement first version using technologies you know or you can learn easily and finish it as soon as possible. Then you will encounter problems like deployment, which you can solve using existing technologies. So start with stupid solutions and enhance it over times.</p>
<h2>jQuery</h2><p>First thing - use and learn jQuery. The DOM API (especially old parts like <code>getElementById</code>) is horrible and jQuery have nicer and easier to use API. Plus all you need to use jQuery is to add <code>scr="https://code.jquery.com/jquery-3.3.1.slim.js"</code> to your HTML and it works. You can get nicer looking code with a minimal effort</p>
<pre>
// DOM API
var element = document.getElementById("id");
// jQuery
var element = $("#id");
</pre><p>Sadly there are things jQuery is not compatible with modern API like needed for <code>sql.js</code> like <code>arraybuffer</code> type for <code>XmlHttpRequest</code>. Fortunately you can combine it with native browser APIs  (unlike <a href="https://reactjs.org/docs/integrating-with-other-libraries.html">ReactJS</a> which builds own Virtual DOM). Which is important in case you're junior and exploring the world.</p>
<h2>Avoid nested code</h2><p>For a simple application you'll be building, try to avoid having nested code. If you define function inside function inside callback definition, you're doing something wrong. This is problematic given the fact Javascript is event based and you register callback all around.</p>
<p>The problem I have had was</p>
<p><ol></p>
<li>You need to use <code>XmlHttpRequest</code> to download your database file</li>
<li>THEN you can instantiate database and send first request to worker</li>
<li>THEN is your application ready</li><p>And while this is trivial to write in traditional environment, <code>XmlHttpRequest</code> is asynchronous, so all you know if that you're ready when <em>callback</em> is called.</p>
<pre>
var worker = new Worker ("worker.sql.js");
...
var xhr = new XmlHttpRequest ();

...
xhr.onload = function (event) {
    ...
    worker.postMessage({
        id:id,
        action:'open',
        buffer: uInt8Array,
    });
    // enable execute button, so you can post SQL queries to worker
    $("#execute").removeAttr ("disabled");
}
</pre><p>The most important method is enabling the button after sqlite file is downloaded and first job to worker is sent. For non interactive application, you''ll simply fire some event or call the callback.</p>
<h2>console.log and browser's REPL</h2><p>Can't emphasize how great tool is <code>console.log</code>. It does not work like Python or similar REPL printing strings.  Browser will deal with logged things like with objects, so all the structure become visible to you immediately. This is very powerful tool, especially for novices in the field.</p>
<p>This becomes extremely important when you're dealing with a relatively simple tasks, like how to iterate through <code>Object</code> or <code>Map</code> in the language.</p>
<h2>Kinkip: The result</h2><p>The world of web applications and Javascript programming is way more powerful and developer friendly. I particularly love the move to client side rendering and with WebWorkers, XmlHttpRequest or emscripten and WebAssembly, you have barely no limits in what you can achieve.</p>
<p>The result is <a href="/kinkip/index.html">Kinkip</a>, helper tool for <a href="https://play.google.com/store/apps/details?id=com.apnax.wordsnack.csk&hl=en">Piknik slov - Word Snack</a> game, which allows you to search for a words you can get from given range of characters. It is powered by <a href="https://github.com/kripken/sql.js">sql.js</a> and GNU FDL Czech - English dictionary from <a href="https://www.svobodneslovniky.cz/">svobodneslovniky.cz</a>. The beauty of it is that all operations are done client side. If properly cached, it works completely offline.</p>
<p>The downside is the game is no longer fun to play :-)</p>

  </div>

  
    
  <div class="blog-post">
  
    <h2><a href="../blog/python-decorators-for-dummies/">Python decorators for dummies</a></h2>
  
  <p class="meta">
    written by
    
      <a href="https://twitter.com/@vyskocilm">Michal Vyskocil</a>
    
    on 2018-01-23
  </p>
  <h2>About</h2><p><a href="https://www.python.org/dev/peps/pep-0318/">Python decoratos</a> is very powerful tool for Python developers. Most of the time I am on user side, however sometimes I need to write my own one. This post is my simple braindump on how to write it.</p><h2>Decorator without arguments</h2><pre>
# to update wrapper function to looks like wrapped one, fixes stack traces, function name, and so
from functools import wraps

# name of decorator, to be used as @prnt
def prnt (f):
    # make wrapper looking like wrapped function f
    @wraps (f)
    def wrapper (*args, **kwargs):
        # custom action called prior function call
        print ("calling %s" % f.__name__)
        # call function and return result
        return f (*args, **kwargs)
    # return wrapper function
    return wrapper
</pre><p>
So usage is simple
</p><pre>
@prnt
def func (i):
    return i

# usage
>>> func (42)
calling func
42
>>>
</pre><h2>Decorator with arguments</h2><p>
You can parametrize decorator itself. Typical example would be Flask's <code>app.route ("/url")</code> used to register route with function handler. Technically you're simply adding an another scope.
</p><pre>
from __future__ import print_function
import sys
# to update wrapper function to looks like wrapped one, fixes stack traces, function name, and so
from functools import wraps

# name of decorator, to be used as @prnt
def prnt (out):
    # this part will run during paring of function declaration
    print ("out=%s" % out)
    def wrapper_f (f):
        # this runs after function is really called
        # make wrapper looking like wrapped function f
        @wraps (f)
        def wrapper (*args, **kwargs):
            # custom action called prior function call
            print ("calling %s" % f.__name__, file=out)
            # call function and return result
            return f (*args, **kwargs)
        # return wrapper function
        return wrapper
    return wrapper_f
</pre><p>
So usage is simple
</p><pre>
@prnt (sys.stderr)
def func (i):
    return i

out=&lt;open file '&lt;stderr>', mode 'w' at 0x7f18b24571e0>

>>> func (1)
calling func
1
>>> 
</pre><p>
You can see that <code>prnt</code> with parameters is called during function declaration. Where code after <code>wrapper_f</code> is called only when function is called.
</p>
  </div>

  
    
  <div class="blog-post">
  
    <h2><a href="../blog/make-your-usrlocal-user-writable/">Make your /usr/local user writable</a></h2>
  
  <p class="meta">
    written by
    
      <a href="https://twitter.com/@vyskocilm">Michal Vyskocil</a>
    
    on 2018-01-21
  </p>
  <h2>About</h2><p>
I am the long term user of Linux based operating systems.  And as a C developer mostly working on stuff built by GNU autotools. Therefor I need to quickly build, install and test new versions of the software. I usually make changes to lower layers (like <a href="https://github.com/zeromq/czmq/pull/1833">zeromq/czmq</a>).
</p><p>
Typical advice for Linux is  to <strong>not</strong> run things as a root!
</p><h3>What is root</h3><blockquote>
Linux operating systems are multi user ones. Each user account have own documents and
can't interfere with others. Except
root. Root is a super user. It takes it all. Permission checks are not applied
to this user. Never!
</blockquote><h2>The solution</h2><p>The standard installation target for autotools based <code>make install</code> is <code>/usr/local</code>. This is path can be written by root. There are many ways to do to avoid this problem. You can install using <code>sudo</code> helper. You can configure <code>--prefix</code> and related variables like <code>PATH</code>, <code>PKG_CONFIG_PATH</code>, <code>LD_LIBRARY_PATH</code> and so.</p><p>
Or there is way more simpler thing to do
<pre>
$ sudo chown $myuser: /usr/local
</pre>
</p><p>
This is a tip from <a href="http://hintjens.com">Pieter Hintjens's</a> book <a
href="https://hintjens.gitbooks.io/scalable-c/content/chapter1.html">Scalable
C</a>. I actually used all three ways, however cannot be more happy with user writable <code>/usr/local</code>.
</p>
  </div>

  

  
  <div class="pagination">
    
      <span class="disabled">&laquo; Previous</span>
    
    | 1 |
    
      <span class="disabled">Next &raquo;</span>
    
  </div>


        </div>
      </div>
    </div>

    <hr>

    <!-- footer -->
    <footer>
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-md-10 mx-auto">
            <ul class="list-inline text-center">
              <li class="list-inline-item">
                <a href="mailto:michal.vyskocil@gmail.com">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-mail fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li class="list-inline-item">
                <a href="https://twitter.com/vyskocilm">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li class="list-inline-item">
                <a href="https://github.com/vyskocilm">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li class="list-inline-item">
                <a href="https://www.facebook.com/michal.vyskocil.148">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
            </ul>
            <p class="copyright text-muted">Copyright &copy; Michal Vyskocil 2018.<br/>Based on <a href="https://startbootstrap.com/template-overviews/clean-blog/">Bootstrap Clean Blog</a>, powered by <a href="https://getlektor.com">Lektor SCM</a></p>
          </div>
        </div>
      </div>
    </footer>

    <!-- Bootstrap core JavaScript -->
    <script src="../vendor/jquery/jquery.min.js"></script>
    <script src="../vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Custom scripts for this template -->
    <script src="../static/clean-blog.min.js"></script>
    </body>

</html>
